#!/bin/bash

#===============================================================================
# Nginx Log Analyser
# Description: Analyze nginx access logs and display useful statistics
# Usage: nginx-log-analyser <log-file>
#
# Project: https://roadmap.sh/projects/nginx-log-analyser
#===============================================================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

#===============================================================================
# Functions
#===============================================================================

print_usage() {
    echo ""
    echo -e "${CYAN}Nginx Log Analyser${NC}"
    echo "Analyze nginx access logs and display useful statistics"
    echo ""
    echo -e "${BOLD}Usage:${NC}"
    echo "  nginx-log-analyser <log-file>"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  nginx-log-analyser /var/log/nginx/access.log"
    echo "  nginx-log-analyser ./nginx-access.log"
    echo ""
    echo -e "${BOLD}Options:${NC}"
    echo "  -h, --help    Show this help message"
    echo ""
}

print_header() {
    echo ""
    echo -e "${CYAN}${BOLD}$1${NC}"
    echo -e "${CYAN}$(printf '=%.0s' {1..50})${NC}"
}

#===============================================================================
# Analysis Functions
#===============================================================================

# Top 5 IP addresses with most requests
analyze_ip_addresses() {
    print_header "Top 5 IP Addresses with Most Requests"
    
    awk '{print $1}' "$LOG_FILE" | \
        sort | \
        uniq -c | \
        sort -rn | \
        head -5 | \
        awk '{printf "%s - %d requests\n", $2, $1}'
}

# Top 5 most requested paths
analyze_paths() {
    print_header "Top 5 Most Requested Paths"
    
    awk '{print $7}' "$LOG_FILE" | \
        sort | \
        uniq -c | \
        sort -rn | \
        head -5 | \
        awk '{printf "%s - %d requests\n", $2, $1}'
}

# Top 5 response status codes
analyze_status_codes() {
    print_header "Top 5 Response Status Codes"
    
    awk '{print $9}' "$LOG_FILE" | \
        grep -E '^[0-9]{3}$' | \
        sort | \
        uniq -c | \
        sort -rn | \
        head -5 | \
        awk '{printf "%s - %d requests\n", $2, $1}'
}

# Top 5 user agents
analyze_user_agents() {
    print_header "Top 5 User Agents"
    
    # User agent is inside quotes after the referrer
    # Format: "..." "user-agent"
    awk -F'"' '{print $6}' "$LOG_FILE" | \
        sort | \
        uniq -c | \
        sort -rn | \
        head -5 | \
        awk '{
            count = $1
            $1 = ""
            agent = substr($0, 2)  # Remove leading space
            printf "%s - %d requests\n", agent, count
        }'
}

#===============================================================================
# Bonus: Additional Analysis Functions
#===============================================================================

# Summary statistics
show_summary() {
    print_header "Log Summary"
    
    local total_requests=$(wc -l < "$LOG_FILE")
    local unique_ips=$(awk '{print $1}' "$LOG_FILE" | sort -u | wc -l)
    local unique_paths=$(awk '{print $7}' "$LOG_FILE" | sort -u | wc -l)
    
    # Count by status code categories
    local success=$(awk '$9 ~ /^2[0-9]{2}$/' "$LOG_FILE" | wc -l)
    local redirect=$(awk '$9 ~ /^3[0-9]{2}$/' "$LOG_FILE" | wc -l)
    local client_error=$(awk '$9 ~ /^4[0-9]{2}$/' "$LOG_FILE" | wc -l)
    local server_error=$(awk '$9 ~ /^5[0-9]{2}$/' "$LOG_FILE" | wc -l)
    
    echo "Total Requests    : $total_requests"
    echo "Unique IPs        : $unique_ips"
    echo "Unique Paths      : $unique_paths"
    echo ""
    echo "Response Breakdown:"
    echo "  2xx (Success)   : $success"
    echo "  3xx (Redirect)  : $redirect"
    echo "  4xx (Client Err): $client_error"
    echo "  5xx (Server Err): $server_error"
}

#===============================================================================
# Main
#===============================================================================

main() {
    # Show help
    if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
        print_usage
        exit 0
    fi

    # Check if argument provided
    if [ -z "$1" ]; then
        echo -e "${RED}Error: No log file specified${NC}"
        print_usage
        exit 1
    fi

    LOG_FILE="$1"

    # Validate log file exists
    if [ ! -f "$LOG_FILE" ]; then
        echo -e "${RED}Error: File not found: $LOG_FILE${NC}"
        exit 1
    fi

    # Check if file is readable
    if [ ! -r "$LOG_FILE" ]; then
        echo -e "${RED}Error: Cannot read file: $LOG_FILE${NC}"
        echo -e "${YELLOW}Tip: Try running with sudo${NC}"
        exit 1
    fi

    # Check if file is empty
    if [ ! -s "$LOG_FILE" ]; then
        echo -e "${RED}Error: File is empty: $LOG_FILE${NC}"
        exit 1
    fi

    echo ""
    echo -e "${GREEN}${BOLD}═══════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}${BOLD}              NGINX LOG ANALYSER                       ${NC}"
    echo -e "${GREEN}${BOLD}═══════════════════════════════════════════════════════${NC}"
    echo -e "Analyzing: ${BOLD}$LOG_FILE${NC}"

    # Run all analysis
    show_summary
    analyze_ip_addresses
    analyze_paths
    analyze_status_codes
    analyze_user_agents

    echo ""
    echo -e "${GREEN}═══════════════════════════════════════════════════════${NC}"
    echo -e "Analysis complete!"
    echo ""
}

# Run main function
main "$@"
